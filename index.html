<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AwanPajak – Kalkulator Pajak + Firestore</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>AwanPajak</h1>
    <p class="subtitle">Login + Kalkulator PPh/PPN + Simpan Firestore + Export PDF</p>

    <!-- Auth -->
    <div id="auth-section" class="card">
      <h2>Login / Daftar</h2>
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button id="btn-login">Login</button>
      <button id="btn-signup">Create Account</button>
    </div>

    <!-- App -->
    <div id="app-section" class="card hidden">
      <div class="topbar">
        <span id="userbox"></span>
        <button id="btn-signout">Logout</button>
      </div>

      <h3>Kalkulator</h3>
      <label>Jenis Perhitungan</label>
      <select id="taxType">
        <option value="ppn">PPN</option>
        <option value="pph21_adv" selected>PPh (BPJS+PTKP)</option>
      </select>

      <div id="ppnFields" class="hidden">
        <input id="ppn-price" type="number" placeholder="Harga" />
        <input id="ppn-rate" type="number" step="0.01" placeholder="Tarif (default 0.11)" />
      </div>

      <div id="pphFields">
        <input id="gajiPokok" type="number" placeholder="Gaji Pokok /bln" />
        <input id="tunjTetap" type="number" placeholder="Tunjangan Tetap /bln" />
        <input id="tunjLain" type="number" placeholder="Tunjangan Lain /bln" />
        <input id="thr" type="number" placeholder="THR /thn" />
        <select id="statusKawin">
          <option value="TK">Tidak Kawin</option>
          <option value="K">Kawin</option>
        </select>
        <select id="tanggungan">
          <option value="0">0</option><option value="1">1</option>
          <option value="2">2</option><option value="3">3</option>
        </select>
      </div>

      <button id="btn-calc">Hitung</button>
      <button id="btn-save">Simpan ke Database</button>
      <button id="btn-pdf">Export PDF</button>
      <button id="btn-history">Lihat Riwayat</button>

      <div id="result" class="result">—</div>
      <div id="history" class="card hidden"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
		apiKey: "AIzaSyA-Gve2lH2Hiqxf8f8O68XVM55zyZrzzfk",
		authDomain: "awanpajak-d84e3.firebaseapp.com",
		projectId: "awanpajak-d84e3",
		storageBucket: "awanpajak-d84e3.firebasestorage.app",
		messagingSenderId: "127279140899",
		appId: "1:127279140899:web:9c2335aeedde50b7cc6196",
		measurementId: "G-QGC46KP81H"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (s) => document.querySelector(s);
    const fmtIDR = (n) => (n ?? 0).toLocaleString('id-ID');

    function toggleFields() {
      if ($('#taxType').value === 'ppn') {
        $('#ppnFields').classList.remove('hidden');
        $('#pphFields').classList.add('hidden');
      } else {
        $('#pphFields').classList.remove('hidden');
        $('#ppnFields').classList.add('hidden');
      }
    }
    $('#taxType').addEventListener('change', toggleFields);
    toggleFields();

    async function callAPI(body) {
      const res = await fetch('/api/tax', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      return await res.json();
    }

    let lastResult = null;

    $('#btn-calc').addEventListener('click', async () => {
      if ($('#taxType').value === 'ppn') {
        const price = Number($('#ppn-price').value);
        const rate = Number($('#ppn-rate').value || 0.11);
        const data = await callAPI({ type: 'ppn', payload: { price, rate } });
        lastResult = data;
        $('#result').textContent = `Harga: Rp${fmtIDR(data.price)} | PPN: Rp${fmtIDR(data.tax)} | Total: Rp${fmtIDR(data.total)}`;
      } else {
        const payload = {
          gajiPokok: Number($('#gajiPokok').value || 0),
          tunjTetap: Number($('#tunjTetap').value || 0),
          tunjLain: Number($('#tunjLain').value || 0),
          thr: Number($('#thr').value || 0),
          statusKawin: $('#statusKawin').value,
          tanggungan: Number($('#tanggungan').value || 0)
        };
        const data = await callAPI({ type: 'pph21_adv', payload });
        lastResult = data;
        $('#result').innerHTML = `Take Home Pay/bln: <b>Rp${fmtIDR(data.monthly.takeHome)}</b><br/>PPh21/bln: Rp${fmtIDR(data.monthly.pph21)}`;
      }
    });

    $('#btn-save').addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return alert("Harus login dulu");
      if (!lastResult) return alert("Hitung dulu sebelum simpan");
      try {
        await addDoc(collection(db, "users", user.uid, "perhitungan"), {
          ...lastResult,
          timestamp: new Date()
        });
        alert("Berhasil disimpan ke Firestore");
      } catch(e) { alert("Gagal simpan: "+e.message); }
    });

    $('#btn-history').addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return alert("Harus login dulu");
      const snap = await getDocs(collection(db, "users", user.uid, "perhitungan"));
      let html = "<h3>Riwayat</h3><ul>";
      snap.forEach(doc => {
        const d = doc.data();
        html += `<li>${d.kind || ''} - THP/bln: Rp${fmtIDR(d.monthly?.takeHome||0)}</li>`;
      });
      html += "</ul>";
      $('#history').innerHTML = html;
      $('#history').classList.remove('hidden');
    });

    $('#btn-pdf').addEventListener('click', () => {
      if (!lastResult) return alert("Hitung dulu sebelum export");
      html2pdf().from(document.querySelector('#result')).save("hasil-pajak.pdf");
    });

    // Auth events
    $('#btn-login').addEventListener('click', async () => {
      try { await signInWithEmailAndPassword(auth, $('#email').value, $('#password').value); }
      catch(e){ alert("Login gagal: "+e.message); }
    });
    $('#btn-signup').addEventListener('click', async () => {
      try { await createUserWithEmailAndPassword(auth, $('#email').value, $('#password').value); }
      catch(e){ alert("Signup gagal: "+e.message); }
    });
    $('#btn-signout').addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        $('#auth-section').classList.add('hidden');
        $('#app-section').classList.remove('hidden');
        $('#userbox').textContent = user.email;
      } else {
        $('#auth-section').classList.remove('hidden');
        $('#app-section').classList.add('hidden');
      }
    });
  </script>
</body>
</html>
